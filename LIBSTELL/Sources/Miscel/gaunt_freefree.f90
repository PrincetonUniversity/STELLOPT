!-----------------------------------------------------------------------
!     Subroutine:    gaunt_freefree
!     Authors:       S. Lazerson (samuel.lazerson@ipp.mpg.de)
!     Date:          04/18/2021
!     Description:   This subroutine returns the Gaunt Free_Free Factor
!                    <g_{ff}> based on the paper
!                    Sutherland, R. S. (1998). Accurate free-free Gaunt
!                         factors for astrophysical plasmas. Monthly 
!                         Notices of the Royal Astronomical Society, 
!                         300(2), 321â€“330. 
!                        http://doi.org/10.1046/j.1365-8711.1998.01687.x
!                    It is based on interpolation provided for Table 2.
!                    It takes arguments
!                        gamma2: gamma^2 = Z*Z*Ry/(k*T)
!                        u:            u = hc/(lambda*k*T)
!-----------------------------------------------------------------------
      SUBROUTINE gaunt_freefree(gamma2,u,gff)
!-----------------------------------------------------------------------
!     Libraries
!-----------------------------------------------------------------------
      USE stel_kinds, ONLY: rprec
!-----------------------------------------------------------------------
!     Arguments
!          gamma2       Gamma^2=Z*Z*Ry/(k*T)
!          u            u=hc/lambda*k*T
!          gff          Interpolated Gaunt Free-Free Factor
!-----------------------------------------------------------------------
      IMPLICIT NONE
      REAL(rprec), INTENT(in) :: gamma2
      REAL(rprec), INTENT(in) :: u
      REAL(rprec), INTENT(out) :: gff
!-----------------------------------------------------------------------
!     PARAMETERS
!          A     Table 2
!          A1    Rows of Table 2
!          A2    Columns of Table 2
!          Note the notation for the table is reversed.
!-----------------------------------------------------------------------
      REAL(rprec), DIMENSION(17,9) :: A
      REAL(rprec), DIMENSION(17), PARAMETER :: A1 = &
        (/-4.0,-3.5,-3.0,-2.5,-2.0,-1.5,-1.0,-0.5,0.0,0.5,1.0,1.5,2.0,2.5,3.0,3.5,4.0/)
      REAL(rprec), DIMENSION(9), PARAMETER :: A2 = &
        (/-4.0,-3.0,-2.0,-1.0,0.0,1.0,2.0,3.0,4.0/)
!-----------------------------------------------------------------------
!     Variables
!          log10g2, log10u     Log base 10 of input quantities.
!          idex1,idex2         Index for spline tables
!          idex1b,idex2b       idex + 1
!          delta1,delta2       position between table units from [0,1]
!-----------------------------------------------------------------------
      INTEGER :: idex1,idex2, idex1b, idex2b
      REAL(rprec) :: log10g2, log10u, delta1, delta2
!-----------------------------------------------------------------------
!     Begin Subroutine
!-----------------------------------------------------------------------
      gff=0.0
      ! Intializations
      log10g2 = log10(gamma2)
      log10u  = log10(u)
      A = RESHAPE((/5.524300, 5.521300, 5.498300, 5.378000, 5.009000, 4.435400, 3.831700, 3.247200, 2.700800,&
                    4.890600, 4.888500, 4.867400, 4.750700, 4.388600, 3.837800, 3.247000, 2.700600, 2.212400,&
                    4.258100, 4.257700, 4.240300, 4.130700, 3.781600, 3.243600, 2.700800, 2.212600, 1.804100,&
                    3.628400, 3.631100, 3.620800, 3.524600, 3.198500, 2.698200, 2.213400, 1.804900, 1.491800,&
                    3.004800, 3.012500, 3.015200, 2.943400, 2.656000, 2.213100, 1.807100, 1.493300, 1.277100,&
                    2.395400, 2.409600, 2.433400, 2.403500, 2.175900, 1.810900, 1.498100, 1.280100, 1.146600,&
                    1.815300, 1.836700, 1.888000, 1.924300, 1.782500, 1.508800, 1.288600, 1.150700, 1.074700,&
                    1.290300, 1.317300, 1.394000, 1.517000, 1.491300, 1.309800, 1.164900, 1.081700, 1.039200,&
                    0.853140, 0.881520, 0.969750, 1.169900, 1.293900, 1.198800, 1.103300, 1.050100, 1.023700,&
                    0.527060, 0.551720, 0.632670, 0.860420, 1.145300, 1.149700, 1.081300, 1.039800, 1.018900,&
                    0.310120, 0.328290, 0.390000, 0.589370, 0.972540, 1.128400, 1.082500, 1.041900, 1.020200,&
                    0.177720, 0.189630, 0.230940, 0.376250, 0.747760, 1.084400, 1.095700, 1.052400, 1.025800,&
                    0.100690, 0.107960, 0.133150, 0.228140, 0.517140, 0.956080, 1.106500, 1.069300, 1.035500,&
                    0.056791, 0.061071, 0.076219, 0.133950, 0.329880, 0.742910, 1.077700, 1.090000, 1.049500,&
                    0.031977, 0.034444, 0.043211, 0.077187, 0.199710, 0.514600, 0.954790, 1.104200, 1.068000,&
                    0.017993, 0.019399, 0.024409, 0.044007, 0.117170, 0.328260, 0.742810, 1.077000, 1.089400,&
                    0.010121, 0.010918, 0.013760, 0.024939, 0.067498, 0.198700, 0.514620, 0.954660, 1.104000/),&
                    (/17,9/),ORDER=(/2,1/))
      idex1 = MIN(MAX(COUNT(A1<log10u),1),17)
      idex1b = MIN(idex1+1,17)
      idex2 = MIN(MAX(COUNT(A2<log10g2),1),9)
      idex2b = MIN(idex2+1,9)
      delta1 = (log10u - A1(idex1))*2 !delta x = 0.05
      delta2 = (log10g2 - A2(idex2))*1 !delta u = 1.0
      ! 2D Bilinear interpolation
      gff =  A(idex1 , idex2 )*(1.0-delta1)*(1.0-delta2) &
           + A(idex1b, idex2 )*delta1*(1.0-delta2) &
           + A(idex1 , idex2b)*(1.0-delta1)*delta2 &
           + A(idex1b, idex2b)*delta1*delta2
!            PRINT *,gamma2,u,log10g2,log10u,idex1,idex1b,idex2,idex2b,delta1,delta2,gff
      RETURN

!-----------------------------------------------------------------------
!     End Subroutine
!-----------------------------------------------------------------------    
      END SUBROUTINE gaunt_freefree