#!/usr/bin/env python3
import sys, ossys.path.insert(0, '../../pySTEL/')
import numpy as np                    #For Arrays
from math import pi
from libstell.libstell import read_vmec

try:
	qtCreatorPath=os.environ["STELLOPT_PATH"]
except KeyError:
	print("Please set environment variable STELLOPT_PATH")
	sys.exit(1)
failtol = 1.0
filename='wout_HELIOTRON.nc'
data=read_vmec(filename)
if not data:
    print('ERROR Opening File: '+filename)
    sys.exit(0)
else:
    print('EXTENSION: '+filename)
print('==== Scalars ====')
varlist={}
varlist['aspect']=10.48284836721937
varlist['b0']=0.3485147596028901
varlist['wp']=0.033457749605936116
varlist['betatot']=0.10229126170889151
varlist['volume']=179.62680009982628
lfail = 0;
for temp in varlist:
    act = varlist[temp]
    cal = data[temp]
    perct = 100*(abs(act-cal)/act)
    print('  '+temp+': '+str(cal)+'   '+str(act)+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('==== Vectors ====')
varlist={}

#print(data['jcurv'].tolist())

varlist['iotaf']=np.array([[1.0], [1.0118110236220472], [1.0236220472440944], [1.0354330708661417], [1.047244094488189], [1.0590551181102361], [1.0708661417322833], [1.0826771653543308], [1.094488188976378], [1.1062992125984252], [1.1181102362204725], [1.1299212598425197], [1.141732283464567], [1.1535433070866141], [1.1653543307086613], [1.1771653543307088], [1.188976377952756], [1.2007874015748032], [1.2125984251968505], [1.2244094488188977], [1.236220472440945], [1.2480314960629921], [1.2598425196850394], [1.2716535433070866], [1.2834645669291338], [1.295275590551181], [1.3070866141732282], [1.3188976377952755], [1.3307086614173227], [1.34251968503937], [1.3543307086614171], [1.3661417322834646], [1.3779527559055118], [1.389763779527559], [1.4015748031496065], [1.4133858267716537], [1.425196850393701], [1.4370078740157481], [1.4488188976377954], [1.4606299212598426], [1.4724409448818898], [1.484251968503937], [1.4960629921259843], [1.5078740157480315], [1.5196850393700787], [1.531496062992126], [1.5433070866141732], [1.5551181102362204], [1.5669291338582676], [1.5787401574803148], [1.590551181102362], [1.6023622047244095], [1.6141732283464567], [1.625984251968504], [1.6377952755905512], [1.6496062992125986], [1.6614173228346458], [1.6732283464566928], [1.6850393700787403], [1.6968503937007875], [1.7086614173228347], [1.720472440944882], [1.7322834645669292], [1.7440944881889764], [1.7559055118110236], [1.7677165354330708], [1.779527559055118], [1.7913385826771653], [1.8031496062992125], [1.81496062992126], [1.8267716535433072], [1.8385826771653544], [1.8503937007874016], [1.8622047244094488], [1.874015748031496], [1.8858267716535433], [1.8976377952755907], [1.909448818897638], [1.9212598425196852], [1.9330708661417324], [1.9448818897637796], [1.9566929133858268], [1.968503937007874], [1.9803149606299213], [1.9921259842519685], [2.0039370078740157], [2.015748031496063], [2.02755905511811], [2.0393700787401574], [2.0511811023622046], [2.062992125984252], [2.074803149606299], [2.0866141732283463], [2.098425196850394], [2.110236220472441], [2.1220472440944884], [2.1338582677165356], [2.145669291338583], [2.15748031496063], [2.1692913385826773], [2.1811023622047245], [2.1929133858267718], [2.204724409448819], [2.216535433070866], [2.2283464566929134], [2.2401574803149606], [2.251968503937008], [2.263779527559055], [2.2755905511811023], [2.2874015748031495], [2.2992125984251968], [2.311023622047244], [2.322834645669291], [2.3346456692913384], [2.3464566929133857], [2.358267716535433], [2.37007874015748], [2.3818897637795273], [2.393700787401575], [2.405511811023622], [2.417322834645669], [2.4291338582677167], [2.440944881889764], [2.4527559055118107], [2.4645669291338583], [2.4763779527559056], [2.4881889763779528], [2.5]]
)
varlist['presf']=np.array([[17999.162998325995], [17717.93043586087], [17437.81387562775], [17159.929319858642], [16884.27676855354], [16610.856221712445], [16339.667679335358], [16070.711141422285], [15803.986607973218], [15539.494078988162], [15277.233554467111], [15017.20503441007], [14759.40851881704], [14503.844007688014], [14250.511501023], [13999.410998821997], [13750.542501085001], [13503.906007812016], [13259.501519003039], [13017.329034658072], [12777.388554777111], [12539.68007936016], [12304.203608407219], [12070.959141918285], [11839.946679893363], [11611.166222332446], [11384.61776923554], [11160.301320602644], [10938.216876433753], [10718.364436728874], [10500.744001488005], [10285.35557071114], [10072.19914439829], [9861.274722549446], [9652.58230516461], [9446.121892243786], [9241.893483786967], [9039.89707979416], [8840.13268026536], [8642.60028520057], [8447.29989459979], [8254.231508463017], [8063.395126790253], [7874.790749581501], [7688.418376836755], [7504.278008556019], [7322.36964473929], [7142.693285386572], [6965.248930497862], [6790.036580073161], [6617.056234112469], [6446.307892615785], [6277.7915555831105], [6111.507223014447], [5947.454894909792], [5785.634571269143], [5626.046252092505], [5468.689937379877], [5313.565627131255], [5160.673321346642], [5010.013020026041], [4861.584723169448], [4715.388430776862], [4571.4241428482865], [4429.691859383719], [4290.191580383163], [4152.923305846613], [4017.8870357740725], [3885.082770165541], [3754.510509021017], [3626.170252340504], [3500.0620001239995], [3376.185752371504], [3254.541509083018], [3135.12927025854], [3017.949035898071], [2903.0008060016107], [2790.2845805691604], [2679.8003596007193], [2571.548143096287], [2465.527931055862], [2361.7397234794475], [2260.1835203670416], [2160.8593217186444], [2063.767127534256], [1968.9069378138765], [1876.2787525575068], [1785.882571765145], [1697.7183954367918], [1611.786223572447], [1528.0860561721126], [1446.6178932357886], [1367.381734763471], [1290.377580755162], [1215.6054312108622], [1143.0652861305716], [1072.7571455142909], [1004.6810093620182], [938.836877673755], [875.2247504495001], [813.8446276892537], [754.6965093930168], [697.7803955607891], [643.0962861925709], [590.6441812883611], [540.4240808481596], [492.4359848719686], [446.679893359786], [403.1558063116118], [361.86372372744694], [322.8036456072905], [285.97557195114445], [251.37950275900678], [219.0154380308765], [188.88337776675667], [160.98332196664526], [135.3152706305422], [111.8792237584495], [90.67518135036423], [71.70314340628836], [54.9631099262219], [40.45508091016281], [28.17905635811413], [18.13503627007485], [10.323020646042957], [4.743009486018469], [1.395002790004374], [-0.8370016740030242]])
varlist['jcurv']=np.array([[-69942.04265715233], [-70936.29529563744], [-71930.54793412254], [-72755.84630674607], [-73781.3281661332], [-74820.91624594765], [-75874.94838754952], [-76739.03318754038], [-77478.13601519003], [-77978.7492766915], [-78362.08427982769], [-78579.75310254589], [-78766.74692188652], [-78891.82722999714], [-79064.54485319494], [-79246.00715313113], [-79508.70748520728], [-79804.79429874495], [-80181.25118019932], [-80590.66600827516], [-81065.54131373648], [-81564.08553702744], [-82112.51083398705], [-82676.7801070082], [-83278.87625102962], [-83891.93083805099], [-84535.26356212026], [-85186.86190706519], [-85864.00365151477], [-86548.18705915574], [-87254.91963748135], [-87968.29967526798], [-88702.15871753088], [-89442.99588696085], [-90202.6606638735], [-90969.46665969213], [-91753.92699746668], [-92545.67122229468], [-93354.0752203409], [-94170.24861382286], [-95002.36123472448], [-95842.43300198004], [-96697.45709297988], [-97560.83371842362], [-98438.782062064], [-99325.45090868286], [-100225.81526519654], [-101135.08625557389], [-102057.74386174417], [-102989.75842405639], [-103934.44282747405], [-104888.4870108658], [-105854.94446829453], [-106831.2176335961], [-107819.27096113218], [-108816.9994106418], [-109826.29396851774], [-110845.72459209048], [-111876.16587851863], [-112916.40443355398], [-113967.50265317858], [-115028.88754933652], [-116100.6330819208], [-117182.18365645359], [-118273.95214529635], [-119376.01212666712], [-120487.91063162246], [-121609.49378898791], [-122740.82391787824], [-123882.318982309], [-125033.2387013311], [-126193.66141368126], [-127363.40319673823], [-128543.10478098308], [-129731.93831062752], [-130930.04359940102], [-132137.2400617032], [-133354.19414708004], [-134580.07395524933], [-135815.04976771562], [-137058.93221037582], [-138312.35037187746], [-139574.63887508604], [-140845.85959796607], [-142125.97428999594], [-143415.50824142268], [-144713.95499383126], [-146021.29384473726], [-147337.67099887037], [-148663.40509138297], [-149998.27176237758], [-151342.1047038444], [-152695.28537834733], [-154057.8945652683], [-155430.06588608318], [-156811.42645927868], [-158202.66503287887], [-159603.5410503473], [-161014.6457653968], [-162435.30447381627], [-163866.61212231216], [-165307.97486453145], [-166760.38678396307], [-168223.06032297458], [-169697.40371534642], [-171182.56644916264], [-172679.8394508516], [-174188.33008592797], [-175709.62153185302], [-177242.9701278212], [-178789.66520101193], [-180349.0981889787], [-181922.6869022188], [-183509.86111286972], [-185112.35311374845], [-186729.16302170753], [-188362.62050664896], [-190010.4880557663], [-191678.23557029702], [-193360.177477549], [-195066.9713176102], [-196786.36236037104], [-198539.85195464685], [-200313.7363240046], [-202124.74801859685], [-203989.76911401088], [-205907.5279021599], [-207825.28669030895]])
for temp in varlist:
    act = varlist[temp]
    cal = data[temp]
    perct = 100*sum(abs(act-cal)/act)
    print('  '+temp+': '+str(cal[0])+'   '+str(act[0])+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('==== Arrays =====')
varlist={}
varlist['rmnc']=np.array([0.004061062051350977, 0.004726582615448221,0.003307142015676585])
varlist['zmns']=np.array([0.004777697912453389,0.004967282416496383,0.0033398560524154223])
varlist['lmns']=np.array([-0.0024114087536513387,-0.0019297381075209792,-0.0009081039993755677])
varlist['bmnc']=np.array([0.0017944208587453313,0.0008256087535906062,0.00014668566648566114])
for temp in varlist:
    mn  = 4; k   = 16
    act = varlist[temp][0]
    cal = data[temp][k,mn]
    s   = str(k)
    m   = str(int(data['xm'][mn]))
    n   = str(int(data['xn'][mn]))
    perct = 100*abs((act-cal)/act)
    print('  '+temp+'['+s+','+m+','+n+']: '+str(cal)+'   '+str(act)+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
    mn  = 4; k   = 32
    act = varlist[temp][1]
    cal = data[temp][k,mn]
    s   = str(k)
    m   = str(int(data['xm'][mn]))
    n   = str(int(data['xn'][mn]))
    perct = 100*abs((act-cal)/act)
    print('  '+temp+'['+s+','+m+','+n+']: '+str(cal)+'   '+str(act)+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
    mn  = 4; k   = 64
    act = varlist[temp][2]
    cal = data[temp][k,mn]
    s   = str(k)
    m   = str(int(data['xm'][mn]))
    n   = str(int(data['xn'][mn]))
    perct = 100*abs((act-cal)/act)
    print('  '+temp+'['+s+','+m+','+n+']: '+str(cal)+'   '+str(act)+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('=================')

if (lfail):
    print('  STATUS: FAIL!!!!!')
else:
    print('  STATUS: PASS')

sys.exit(0)




