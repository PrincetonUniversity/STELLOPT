#!/usr/bin/env python3
import sys, ossys.path.insert(0, '../../pySTEL/')
import numpy as np                    #For Arrays
from math import pi
from libstell.libstell import read_vmec

try:
	qtCreatorPath=os.environ["STELLOPT_PATH"]
except KeyError:
	print("Please set environment variable STELLOPT_PATH")
	sys.exit(1)
failtol = 1.0
filename='wout_DIII-D.nc'
data=read_vmec(filename)
if not data:
    print('ERROR Opening File: '+filename)
    sys.exit(0)
else:
    print('EXTENSION: '+filename)
print('==== Scalars ====')
varlist={}
varlist['aspect']=2.074164788387933
varlist['b0']=-1.823048261527745
varlist['wp']=0.013426717682170632
varlist['betatot']=0.014895734484922747
varlist['volume']=19.268834566567772
lfail = 0;
for temp in varlist:
    act = varlist[temp]
    cal = data[temp]
    perct = 100*(abs(act-cal)/act)
    print('  '+temp+': '+str(cal)+'   '+str(act)+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('==== Vectors ====')
varlist={}

#print(data['jcurv'].tolist())

varlist['iotaf']=np.array([[0.9555601319642512], [0.9566379608229425], [0.9574582870869611], [0.9577322462314635], [0.9573947008721431], [0.9563947403432169], [0.954707598231278], [0.9523270045192598], [0.949262794226598], [0.9455373853220574], [0.941182749097116], [0.9362378584689856], [0.9307465457190287], [0.9247557030865815], [0.9183137739943592], [0.9114694969619836], [0.9042708733837876], [0.896764335221993], [0.8889940910545415], [0.8810016304298598], [0.8728253677720512], [0.8645004083649261], [0.8560584201916678], [0.8475275965839455], [0.838932695748025], [0.8302951442921527], [0.8216331929293081], [0.8129621135261604], [0.8042944276661262], [0.7956401578347947], [0.787007093274164], [0.778401063428873], [0.7698262127786281], [0.7612852716516845], [0.7527798184061709], [0.7443105290842922], [0.7358774113499694], [0.7274800201491323], [0.7191176531446353], [0.7107895245164626], [0.7024949162392987], [0.694233306394864], [0.6860044745074804], [0.6778085842431536], [0.6696462441590962], [0.661518547455612], [0.6534270919402404], [0.6453739816007156], [0.6373618113595408], [0.6293936367024933], [0.6214729299702861], [0.6136035251638404], [0.6057895531438332], [0.598035369124692], [0.5903454743322939], [0.5827244336793933], [0.5751767912350753], [0.5677069852346303], [0.5603192642522199], [0.5530176061178314], [0.545805641007047], [0.5386865800879989], [0.5316631509289059], [0.5247375408187478], [0.5179113489586271], [0.5111855484161609], [0.5045604585306305], [0.4980357283673104], [0.4916103316119576], [0.4852825731747977], [0.47905010757274347], [0.4729099689949642], [0.4668586127825506], [0.4608919678391852], [0.45500549936657086], [0.4491942810612771], [0.443453075874499], [0.4377764241088423], [0.43215873773145896], [0.42659439936492327], [0.4210778647173177], [0.41560376664509574], [0.4101670196324213], [0.4047629226593692], [0.3993872594089244], [0.3940363935516725], [0.388707358373688], [0.38339793821075674], [0.3781067413916218], [0.3728332616905361], [0.36757792844515524], [0.36234214159504086], [0.3571282921974629], [0.35193976349975314], [0.3467809133682248], [0.3416570316237515], [0.33657427323555655], [0.3315395592731044], [0.3265604467816197], [0.32164495820682315], [0.3168013722410147], [0.3120379667449027], [0.3073627176082073], [0.30278294665543776], [0.29830492651956564], [0.29393344108689595], [0.2896713155841383], [0.2855189224028832], [0.2814736835266465], [0.2775295822035234], [0.2736767091449973], [0.2699008572722449], [0.2661831894150515], [0.26249998681096154], [0.2588224953441018], [0.2551168673923941], [0.2513442036256251], [0.24746068648383118], [0.2434177756063861], [0.23916245128782798], [0.23463736828596587], [0.22978087197744368], [0.22452654819169376], [0.21880127064853058], [0.21252354697785408], [0.20558589880084405], [0.19790670927654624], [0.18984824677015083]])
varlist['presf']=np.array([[59102.0512798974], [58413.83034930654], [57671.18236482699], [56829.242747017044], [55906.09068820963], [54917.79500515718], [53878.57279148868], [52800.94078511942], [51695.85938972333], [50572.86932555712], [49440.220918702034], [48304.99606921634], [47173.22296783574], [46049.98365777435], [44939.514562928096], [43845.30012642524], [42770.159724062556], [41716.328035773484], [40685.52907495298], [39679.04409027485], [38697.77356763927], [37742.29357114138], [36812.90667151589], [35909.687718447305], [35032.52471949987], [34181.15509327637], [33355.19756781928], [32554.179997281244], [31777.563370575026], [31024.762285124674], [30295.162157039522], [29588.133436081203], [28903.043089750026], [28239.263615740936], [27596.179835970466], [26973.19371841433], [26369.727465180287], [25785.22509663232], [25219.152752039987], [24670.997917209977], [24140.267778926263], [23626.48689483943], [23129.194355765245], [22647.940605236825], [22182.284068662615], [21731.78773163601], [21296.015793878207], [20874.53051203602], [20466.88933116005], [20072.642391214886], [19691.33048148128], [19322.48350226237], [18965.61947995905], [18620.24416839513], [18285.851256309863], [17961.923188251913], [17647.932593770114], [17343.34430785449], [17047.617954100715], [16760.21105111248], [16480.582592274277], [16208.197039287928], [15942.528660823693], [15683.066139354481], [15429.317361777203], [15180.814302839828], [14937.117904746208], [14697.822851657695], [14462.562134220663], [14231.011296773544], [14002.892258587199], [13777.976600430784], [13556.088208990379], [13337.105174257476], [13120.960839010297], [12907.643904992143], [12697.197507408864], [12489.717177977336], [12285.347627022216], [12084.278287101475], [11886.737574392519], [11692.985839659299], [11503.306998100594], [11317.998846818213], [11137.362100085804], [10961.68819611943], [10791.245954707509], [10626.267192896881], [10466.931436023075], [10313.34989379003], [10165.548905877058], [10023.45309875366], [9886.868535090129], [9755.466179398021], [9628.766048389309], [9506.122462079924], [9386.710861916072], [9269.516715242453], [9153.32708134592], [9036.72547308823], [8918.090709927394], [8795.600522934219], [8667.240740278317], [8530.820952712136], [8383.997632801913], [8224.305759183433], [8049.200077963091], [7856.107217559295], [7642.489960991989], [7405.925070798567], [7144.1961564473095], [6855.403172544125], [6538.090238141736], [6191.393573211277], [5815.211458038804], [5410.398234675038], [4978.984486965393], [4524.42565707902], [4051.881481870449], [3568.5287618913535], [3083.910109521559], [2610.3214606656256], [2163.2412765794143], [1761.8045088765427], [1429.3245517744108], [1193.8665609904638], [1088.8756785203805], [1058.1931704172387]])
varlist['jcurv']=np.array([[548612.0973783606], [550095.3945342215], [551578.6916900823], [552125.9102268923], [551609.0190730798], [549968.8092501456], [547200.3741697561], [543340.5706143435], [538457.2741699049], [532640.2546969042], [525993.5087813119], [518628.89701177704], [510660.9443881965], [502202.6721913943], [493362.33923996927], [484240.9796386386], [474930.6328897507], [465513.17060525913], [456059.63202875043], [446629.98816334404], [437273.26151262317], [428027.9352822453], [418922.5923731503], [409976.7306274752], [401201.70657541486], [392601.765385089], [384175.11984363804], [375915.0460072768], [367810.9676571803], [359849.5058977921], [352015.47413953487], [344292.8023305725], [336665.37764924753], [329117.7919473174], [321635.98905543773], [314207.8076323832], [306823.41756722785], [299475.650039251], [292160.2232088974], [284875.8671670433], [277624.35321343207], [270410.4337804016], [263241.7003717398], [256128.36775539632], [249082.99334608065], [242120.14124250144], [235256.00075565965], [228507.96948715096], [221894.21109895932], [215433.19786324393], [209143.24790757414], [203042.06677981914], [197146.30255860373], [191471.1232380313], [186029.8245322971], [180833.47556773393], [175890.6092026756], [171206.96288667977], [166785.27512988442], [162625.14172128728], [158722.93489096215], [155071.7876320599], [151661.64437799755], [148479.3782207425], [145508.97382772117], [142731.77417855425], [140126.78824221736], [137671.05571309332], [135340.06394895606], [133108.21134436363], [130949.31045381099], [128837.12336843168], [126745.92107473715], [124651.0577996692], [122529.55074791082], [120360.65506583858], [118126.42346945926], [115812.23956850231], [113407.31374614626], [110905.13032452301], [108303.83472824808], [105606.54960855767], [102821.60907277254], [99962.70070785804], [97048.90569079855], [94104.62798560473], [91159.40477784694], [88247.59120025043], [85407.91396970263], [82682.89005456012], [80118.10810413845], [77761.37269294012], [75661.7132424224], [73868.26229494078], [72429.01031237746], [71389.44721354257], [70791.10399319207], [70670.01146318884], [71055.09664652278], [71966.54165045642], [73414.13415681208], [75395.64312463264], [77895.25870311788], [80882.14013776089], [84309.12151580618], [88111.63104672694], [92206.88553755161], [96493.42915023788], [100851.09161063045], [105141.44964678597], [109208.88154285232], [112882.31494218064], [115977.77492460956], [118301.84897255656], [119656.1950581752], [119843.22885507066], [118673.1357501589], [115972.36461661627], [111593.77194311848], [105428.5946891344], [97420.44430481415], [87581.52644985999], [76011.30209110648], [62917.82262850204], [48641.98230459633], [33684.94757583263], [18739.038136603205], [3793.128697373781]])
for temp in varlist:
    act = varlist[temp]
    cal = data[temp]
    perct = 100*sum(abs(act-cal)/act)
    print('  '+temp+': '+str(cal[0])+'   '+str(act[0])+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('==== Arrays =====')
varlist={}
varlist['rmnc']=np.array([0.2391804844908614, 0.3349325524255217,0.4584715791461059])
varlist['zmns']=np.array([0.3367046932389417,0.4794704103234545,0.6922615873446487])
varlist['lmns']=np.array([-0.21712405593590045,-0.31274843176653083,-0.44400101837981026])
varlist['bmnc']=np.array([-0.25620283044478037,-0.362798719741285,-0.5153885260608784])
for temp in varlist:
    mn  = 1; k   = 16
    act = varlist[temp][0]
    cal = data[temp][k,mn]
    s   = str(k)
    m   = str(int(data['xm'][mn]))
    n   = str(int(data['xn'][mn]))
    perct = 100*abs((act-cal)/act)
    print('  '+temp+'['+s+','+m+','+n+']: '+str(cal)+'   '+str(act)+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
    mn  = 1; k   = 32
    act = varlist[temp][1]
    cal = data[temp][k,mn]
    s   = str(k)
    m   = str(int(data['xm'][mn]))
    n   = str(int(data['xn'][mn]))
    perct = 100*abs((act-cal)/act)
    print('  '+temp+'['+s+','+m+','+n+']: '+str(cal)+'   '+str(act)+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
    mn  = 1; k   = 64
    act = varlist[temp][2]
    cal = data[temp][k,mn]
    s   = str(k)
    m   = str(int(data['xm'][mn]))
    n   = str(int(data['xn'][mn]))
    perct = 100*abs((act-cal)/act)
    print('  '+temp+'['+s+','+m+','+n+']: '+str(cal)+'   '+str(act)+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('=================')

if (lfail):
    print('  STATUS: FAIL!!!!!')
else:
    print('  STATUS: PASS')

sys.exit(0)




