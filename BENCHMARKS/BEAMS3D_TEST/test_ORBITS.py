#!/usr/bin/env python3
import sys, os
sys.path.insert(0, '../../pySTEL/')
import numpy as np                    #For Arrays
from math import pi
from libstell.beams3d import read_beams3d

try:
	qtCreatorPath=os.environ["STELLOPT_PATH"]
except KeyError:
	print("Please set environment variable STELLOPT_PATH")
	sys.exit(1)

lfail = 0
failtol = 1.0
filename='beams3d_ORBITS.h5'
data=read_beams3d(filename)
if not data:
    print('ERROR Opening File: '+filename)
    sys.exit(0)

# Calc values
rho = np.sqrt(data['S_lines'])
rho_max = np.max(rho,axis=1)
rho_min = np.min(rho,axis=1)
data['delta'] = rho_max-rho_min
x = data['R_lines']-10.0
y = data['Z_lines']
theta = np.arctan2(y,x)
theta = np.where(theta > np.pi,theta-pi,theta)
data['turning'] = np.max(theta,axis=1)
data['R0']=data['R_lines'][:,0]
data['R1']=data['R_lines'][:,1]
data['R100']=data['R_lines'][:,100]
data['R500']=data['R_lines'][:,500]

print('BEAMS3D VERSION: ' + str(data['VERSION']))
print('==== Vectors ====')
varlist={}
varlist['turning']=np.array([0.12275448, 0.1788069,  0.23483922, 0.29094046, 0.34722868, 0.40375728,
 0.46065893, 0.51799329, 0.57587523, 0.63441059, 0.69368621, 0.75391989,
 0.81514834, 0.87755329, 0.94131251, 1.0066042,  1.073641,   1.14261056,
 1.21404663, 1.2880335,  1.36508321, 1.44570684, 1.53053939, 1.62039918,
 1.71639094, 1.81999506, 1.93335501, 2.05975875, 2.20481267, 2.37949053,
 2.61309783, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000,
 0.00000000, 0.00000000, 0.00000000, 0.00000000 ])
varlist['delta']= np.array([0.00946046, 0.01374876, 0.01800757, 0.02223544, 0.026432,   0.03059698,\
 0.03473095, 0.038831,   0.04289777, 0.04693171, 0.05093049, 0.05489528,\
 0.05882575, 0.06272063, 0.06658121, 0.07040614, 0.07419578, 0.07794811,\
 0.08166657, 0.08535033, 0.08900042, 0.09261682, 0.09619758, 0.09974838,\
 0.10326324, 0.10674989, 0.11020544, 0.11363556, 0.11703701, 0.12041313,\
 0.12377785, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000,\
 0.00000000, 0.00000000, 0.00000000, 0.00000000])
varlist['R0'] = np.array([10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5,\
 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, \
 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5])
varlist['R1'] = np.array([10.49999249, 10.4999768,  10.49995341, 10.49992237, 10.49988369, 10.49983742,\
 10.49978361, 10.49972231, 10.49965359, 10.49957753, 10.49949421, 10.49940373,\
 10.49930618, 10.49920166, 10.49909031, 10.49897222, 10.49884755, 10.49871641,\
 10.49857895, 10.49843531, 10.49828565, 10.49813011, 10.49796888, 10.49780209,\
 10.49762991, 10.49745252, 10.49727009, 10.49708281, 10.49689083, 10.49669435,\
 10.49649352, 10.49628857, 10.49607966, 10.49586693, 10.49565066, 10.49543094,\
 10.49520799, 10.49498197, 10.49475306, 10.49452144])
varlist['R100'] = np.array([10.49952811, 10.49841904, 10.49681967, 10.49483304, 10.492617,   10.49038081,\
 10.48835247, 10.48679273, 10.48597115, 10.48610144, 10.48735746, 10.48975565,\
 10.49305676, 10.49667017, 10.4994585,  10.49956161, 10.49424657, 10.47989742,\
 10.45232043, 10.40751938, 10.3430584,  10.25952967, 10.16163861, 10.05781398,\
  9.95865638,  9.87499126, 9.81717158,  9.79843648,  9.84903473, 10.06874637,\
 10.6121399,   9.52383909, 10.30811992,  9.75552682,  9.55757415,  9.49714706,\
  9.53072501,  9.65828663,  9.8739292,  10.13929343])
varlist['R500'] = np.array([10.50935564, 10.51357954, 10.51765357, 10.52124379, 10.52347226, 10.52254675,\
 10.51578596, 10.50004569, 10.4733993,  10.43816937, 10.40258562, 10.38083631,
 10.38821076, 10.43096549, 10.48682747, 10.48925378, 10.38571913, 10.24399162,
 10.19729589, 10.3383645,  10.57590636, 10.4012457,  10.04725902, 10.08337319,
 10.4931221,  10.02518826,  9.89786486, 10.5743704,   9.68899905, 10.29549756,
 10.40735214,  9.48140819,  9.51059377,  9.7825418,  10.21186358,  9.52381988,
 10.35010235,  9.61176158,  9.92985194, 10.13460947])
for temp in varlist:
    act = varlist[temp]
    cal = data[temp]
    cal = np.where(act==0,0,cal)
    div = np.where(act==0,1,act)
    perct = 100*sum(abs(act-cal)/div)
    print('  '+temp+': '+str(cal[0])+'   '+str(act[0])+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('=================')

if (lfail):
    print('  STATUS: FAIL!!!!!')
else:
    print('  STATUS: PASS')

sys.exit(0)




