#!/usr/bin/env python3
import sys, os
sys.path.insert(0, '../../pySTEL/')
import numpy as np                    #For Arrays
from math import pi
from libstell.beams3d import read_beams3d

try:
	qtCreatorPath=os.environ["STELLOPT_PATH"]
except KeyError:
	print("Please set environment variable STELLOPT_PATH")
	sys.exit(1)

lfail = 0
failtol = 1.0
filename='beams3d_ORBITS.h5'
data=read_beams3d(filename)
if not data:
    print('ERROR Opening File: '+filename)
    sys.exit(0)

# Calc values
rho = np.sqrt(data['S_lines'])
rho_max = np.max(rho,axis=1)
rho_min = np.min(rho,axis=1)
data['delta'] = rho_max-rho_min
x = data['R_lines']-10.0
y = data['Z_lines']
theta = np.arctan2(y,x)
theta = np.where(theta > np.pi,theta-pi,theta)
data['turning'] = np.max(theta,axis=1)
data['R0']=data['R_lines'][:,0]
data['R1']=data['R_lines'][:,1]
data['R100']=data['R_lines'][:,100]
data['R500']=data['R_lines'][:,500]

print('BEAMS3D VERSION: ' + str(data['VERSION']))
print('==== Vectors ====')
varlist={}
varlist['turning']=np.array([0.125963,0.192178,0.256552,0.322278,0.386939,0.452593,0.517807,0.582154, \
 0.647486,0.714103,0.780536,0.848644,0.916766,0.985516,1.055609,1.127077, \
 1.199862,1.273956,1.349854,1.427739,1.50775 ,1.590523,1.676377,1.766025, \
 1.860114,1.960032,2.067073,2.183691,2.314101,2.466324,2.659332,3.031584, \
 3.139698,3.137183,3.140747,3.138239,3.133765,3.123393,3.131218,3.141036])
varlist['delta']= np.array([0.008728,0.01301 ,0.017264,0.021489,0.025684,0.02985 ,0.033981,0.038089, \
 0.042163,0.046204,0.050216,0.054197,0.058143,0.062052,0.065917,0.069746, \
 0.073547,0.077324,0.08107 ,0.084782,0.088459,0.0921  ,0.095706,0.099279, \
 0.102808,0.106312,0.109776,0.113197,0.116582,0.119931,0.123247,0.126529, \
 0.050254,0.046026,0.043131,0.040904,0.039089,0.037559,0.036249,0.0351  ])
varlist['R0'] = np.array([10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5,\
 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, \
 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5])
varlist['R1'] = np.array([10.499992,10.499976,10.499953,10.499923,10.499885,10.49984 ,10.499788, \
 10.499728,10.499661,10.499588,10.499507,10.499419,10.499325,10.499223, \
 10.499115,10.499   ,10.498879,10.498752,10.498619,10.49848 ,10.498335, \
 10.498187,10.498033,10.497875,10.497711,10.497541,10.497367,10.497187, \
 10.497001,10.49681 ,10.496615,10.496416,10.496213,10.496006,10.495796, \
 10.495583,10.495366,10.495147,10.494925,10.4947  ])
varlist['R100'] = np.array([10.499668,10.49954 ,10.498415,10.495994,10.492048,10.489018,10.484764, \
 10.478801,10.470844,10.4609  ,10.450495,10.430634,10.41262 ,10.391786, \
 10.359234,10.32515 ,10.284436,10.238338,10.187575,10.131399,10.072618, \
 10.012304, 9.953646, 9.899113, 9.852518, 9.818266, 9.801941, 9.817014, \
  9.886363,10.089501,10.531777, 9.507029,10.323958, 9.756539, 9.56003 , \
  9.498529, 9.518629, 9.621469, 9.809532,10.056841])
varlist['R500'] = np.array([10.501912,10.495581,10.493947,10.499721,10.510881,10.509234,10.511454, \
 10.518998,10.530846,10.54234 ,10.549063,10.539635,10.51629 ,10.475989, \
 10.372345,10.278064,10.195833,10.161129,10.195158,10.315201,10.465567, \
 10.466432,10.207134, 9.932726, 9.887586,10.245104,10.564814, 9.795678, \
  9.768543,10.204078, 9.709724, 9.482711, 9.512327, 9.813837,10.101434, \
  9.570304,10.11365 , 9.804845, 9.64878 ,10.473322])
for temp in varlist:
    act = varlist[temp]
    cal = data[temp]
    #print(np.array2string(cal,precision=6, separator=','))
    cal = np.where(act==0,0,cal)
    div = np.where(act==0,1,act)
    perct = 100*sum(abs(act-cal)/div)
    print('  '+temp+': '+str(cal[0])+'   '+str(act[0])+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('=================')

if (lfail):
    print('  STATUS: FAIL!!!!!')
else:
    print('  STATUS: PASS')

sys.exit(0)




