#!/usr/bin/env python3
import sys, os
sys.path.insert(0, '../../pySTEL/')
import numpy as np                    #For Arrays
from math import pi
from libstell.beams3d import read_beams3d

try:
	qtCreatorPath=os.environ["STELLOPT_PATH"]
except KeyError:
	print("Please set environment variable STELLOPT_PATH")
	sys.exit(1)

lfail = 0
failtol = 1.0
filename='beams3d_ORBITS_er.h5'
data=read_beams3d(filename)
if not data:
    print('ERROR Opening File: '+filename)
    sys.exit(0)

# Calc values
rho = np.sqrt(data['S_lines'])
rho_max = np.max(rho,axis=1)
rho_min = np.min(rho,axis=1)
data['delta'] = rho_max-rho_min
x = data['R_lines']-10.0
y = data['Z_lines']
theta = np.arctan2(y,x)
theta = np.where(theta > np.pi,theta-pi,theta)
data['turning'] = np.max(theta,axis=1)
data['R0']=data['R_lines'][:,0]
data['R1']=data['R_lines'][:,1]
data['R100']=data['R_lines'][:,100]
data['R500']=data['R_lines'][:,500]

print('BEAMS3D VERSION: ' + str(data['VERSION']))
print('==== Vectors ====')
varlist={}
varlist['turning']=np.array([0.821381,0.887084,0.953888,1.021039,1.090111,1.159467,1.230705,1.303085, \
 1.377511,1.453895,1.532393,1.613656,1.69797 ,1.78599 ,1.8786  ,1.976926, \
 2.082312,2.197332,2.325818,2.476515,2.667481,3.042819,3.138018,3.140987, \
 3.140416,3.141356,3.139775,3.138737,3.134942,3.141573,3.136121,3.138777, \
 3.136461,3.1278  ,3.138144,3.138398,3.129153,3.140236,3.141283,3.140198])
varlist['delta']= np.array([0.053669,0.057585,0.06153 ,0.065428,0.069293,0.073123,0.076936,0.080732, \
 0.08451 ,0.088244,0.091954,0.095633,0.099285,0.102901,0.106495,0.11005 , \
 0.113558,0.117027,0.120484,0.123932,0.127301,0.130674,0.047465,0.043212, \
 0.040298,0.038056,0.036237,0.034698,0.03338 ,0.032227,0.03121 ,0.030298, \
 0.029481,0.028742,0.028068,0.027452,0.026884,0.026364,0.025885,0.02544 ])
varlist['R0'] = np.array([10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5,\
 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, \
 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5])
varlist['R1'] = np.array([10.49942 ,10.499323,10.499219,10.499107,10.498988,10.498862,10.498729, \
 10.498589,10.498442,10.498289,10.49813 ,10.497966,10.497795,10.497618, \
 10.497434,10.497243,10.497045,10.49684 ,10.496629,10.496412,10.49619 , \
 10.495963,10.495731,10.495494,10.495253,10.495006,10.494756,10.494502, \
 10.494243,10.493981,10.493715,10.493446,10.493174,10.492899,10.492621, \
 10.49234 ,10.492057,10.491772,10.491486,10.491197])
varlist['R100'] = np.array([10.456256,10.443088,10.425395,10.403627,10.373189,10.34204 ,10.304662, \
 10.259554,10.20543 ,10.148178,10.08626 ,10.021709, 9.957483, 9.896362, \
  9.841849, 9.798294, 9.770817, 9.769611, 9.812737, 9.979393,10.423131, \
  9.502357,10.095258, 9.627057, 9.510626, 9.508025, 9.604538, 9.811865, \
 10.099474,10.366702,10.496165,10.447198,10.272651,10.054047, 9.849678, \
  9.687566, 9.576998, 9.519707, 9.515417, 9.563329])
varlist['R500'] = np.array([10.51114 ,10.534204,10.557405,10.561068,10.513376,10.433504,10.318139, \
 10.190652,10.100635,10.099054,10.210251,10.416362,10.481506,10.175722, \
  9.866236, 9.872512,10.399772,10.255711, 9.641376,10.466586, 9.547744, \
  9.481761, 9.536795, 9.495085, 9.989194, 9.779026, 9.855615, 9.707868, \
 10.259663, 9.510789,10.408684, 9.759027, 9.659793,10.49936 , 9.66123 , \
  9.717035,10.499987, 9.737478, 9.620918,10.435203])

for temp in varlist:
    act = varlist[temp]
    cal = data[temp]
    #print(np.array2string(cal,precision=6, separator=','))
    cal = np.where(act==0,0,cal)
    div = np.where(act==0,1,act)
    perct = 100*sum(abs(act-cal)/div)
    print('  '+temp+': '+str(cal[0])+'   '+str(act[0])+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('=================')

if (lfail):
    print('  STATUS: FAIL!!!!!')
else:
    print('  STATUS: PASS')

sys.exit(0)




