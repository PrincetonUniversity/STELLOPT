#!/usr/bin/env python3
import sys, os
sys.path.insert(0, '../../pySTEL/')
import numpy as np                    #For Arrays
from math import pi
from libstell.beams3d import read_beams3d

try:
	qtCreatorPath=os.environ["STELLOPT_PATH"]
except KeyError:
	print("Please set environment variable STELLOPT_PATH")
	sys.exit(1)

lfail = 0
failtol = 1.0
filename='beams3d_ORBITS_er.h5'
data=read_beams3d(filename)
if not data:
    print('ERROR Opening File: '+filename)
    sys.exit(0)

# Calc values
rho = np.sqrt(data['S_lines'])
rho_max = np.max(rho,axis=1)
rho_min = np.min(rho,axis=1)
data['delta'] = rho_max-rho_min
x = data['R_lines']-10.0
y = data['Z_lines']
theta = np.arctan2(y,x)
theta = np.where(theta > np.pi,theta-pi,theta)
data['turning'] = np.max(theta,axis=1)
data['R0']=data['R_lines'][:,0]
data['R1']=data['R_lines'][:,1]
data['R100']=data['R_lines'][:,100]
data['R500']=data['R_lines'][:,500]

print('BEAMS3D VERSION: ' + str(data['VERSION']))
print('==== Vectors ====')
varlist={}
varlist['turning']=np.array([0.731818,0.790782,0.850847,0.912064,0.974695,1.0389  ,1.104844,1.172828,\
 1.243086,1.316016,1.392043,1.47161 ,1.555398,1.644202,1.739113,1.841627,\
 1.953858,2.07915 ,2.223071,2.396822,2.630443,3.14082 ,3.137172,3.14054 ,\
 3.140729,3.139554,3.125797,3.137596,3.133379,3.136083,3.137402,3.130642,\
 3.141268,3.051788,3.137851,3.131645,3.140143,3.094711,3.105806,3.070548])
varlist['delta']= np.array([0.05423809, 0.05817742, 0.06208664, 0.06597614, 0.06983697, 0.07367174, \
 0.07747871, 0.08125854, 0.08501104, 0.08873631, 0.09243478, 0.096107, \
 0.09975398, 0.1033743,  0.1069705,  0.11053931, 0.11408478, 0.11761708, \
 0.12112878, 0.12461822, 0.12809816, 0.05480828, 0.04660301, 0.04265478, \
 0.03987399, 0.03770953, 0.03593645, 0.03444081, 0.0331503,  0.03201852, \
 0.03101717, 0.03012036, 0.02931986, 0.02858762, 0.02792307, 0.02731063, \
 0.02675561, 0.02624057, 0.02576578, 0.02532567])
varlist['R0'] = np.array([10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5,\
 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, \
 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5, 10.5])
varlist['R1'] = np.array([10.499419,10.499322,10.499218,10.499106,10.498987,10.498861,10.498727,\
 10.498587,10.498439,10.498285,10.498123,10.497955,10.497781,10.4976  ,\
 10.497413,10.497219,10.49702 ,10.496815,10.496604,10.496387,10.496165,\
 10.495938,10.495706,10.495469,10.495227,10.494981,10.49473 ,10.494476,\
 10.494217,10.493955,10.493689,10.49342 ,10.493147,10.492871,10.492593,\
 10.492312,10.492028,10.491742,10.491454,10.491165])
varlist['R100'] = np.array([10.493445,10.495821,10.498192,10.499819,10.499354,10.494654,10.483016,\
 10.460992,10.425145,10.372862,10.302601,10.217115,10.121475,10.024009,\
  9.933954, 9.860646, 9.813156, 9.804754, 9.867585,10.106326,10.624484,\
  9.57462 ,10.212636, 9.699024, 9.534736, 9.499788, 9.564236, 9.732713,\
  9.991245,10.27394 ,10.466867,10.485248,10.348678,10.139893, 9.927953,\
  9.748536, 9.616211, 9.536432, 9.511147, 9.540267])
varlist['R500'] = np.array([10.402128,10.421311,10.459464,10.495527,10.484362,10.393512,10.269624,\
 10.205779,10.279917,10.495403,10.563824,10.233654,10.008084,10.193079,\
 10.474319, 9.921367, 9.990735,10.457969, 9.692126,10.130198,10.580243,\
  9.614211, 9.490125, 9.56689 ,10.49832 , 9.519342,10.404415, 9.508368,\
 10.4827  , 9.586594, 9.951379,10.19767 , 9.509499,10.283215,10.013122,\
  9.526967,10.310379,10.087571, 9.51175 ,10.133581])

for temp in varlist:
    act = varlist[temp]
    cal = data[temp]
    #print(np.array2string(cal,precision=6, separator=','))
    cal = np.where(act==0,0,cal)
    div = np.where(act==0,1,act)
    perct = 100*sum(abs(act-cal)/div)
    print('  '+temp+': '+str(cal[0])+'   '+str(act[0])+'   '+str(int(perct))+'%')
    if perct > failtol:
        lfail = 1
print('=================')

if (lfail):
    print('  STATUS: FAIL!!!!!')
else:
    print('  STATUS: PASS')

sys.exit(0)




